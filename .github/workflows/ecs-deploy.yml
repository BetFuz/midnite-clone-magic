name: ECS Blue-Green Deployment

on:
  push:
    tags:
      - 'v*'

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: betfuz-backend
  ECS_CLUSTER: betfuz-prod-cluster
  ECS_SERVICE: betfuz-api-service
  TASK_DEFINITION: betfuz-task-def
  CONTAINER_NAME: betfuz-api
  POSTMAN_COLLECTION_URL: https://api.getpostman.com/collections/${{ secrets.POSTMAN_COLLECTION_ID }}
  SMOKE_TEST_AMOUNT: 100  # ‚Ç¶100 hot-wallet smoke test

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.version.outputs.VERSION }}
        run: |
          docker build \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            -f backend/Dockerfile \
            ./backend
          
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      - name: Download task definition
        run: |
          aws ecs describe-task-definition \
            --task-definition ${{ env.TASK_DEFINITION }} \
            --query taskDefinition > task-definition.json

      - name: Update task definition with new image
        id: task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: task-definition.json
          container-name: ${{ env.CONTAINER_NAME }}
          image: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.version.outputs.VERSION }}

      - name: Deploy to ECS with Blue-Green
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.task-def.outputs.task-definition }}
          service: ${{ env.ECS_SERVICE }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true
          codedeploy-appspec: appspec.yml
          codedeploy-application: betfuz-codedeploy-app
          codedeploy-deployment-group: betfuz-deployment-group

      - name: Wait for green environment to stabilize
        run: sleep 60

      - name: Run Postman smoke tests
        id: postman-tests
        continue-on-error: true
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
        run: |
          # Install Newman (Postman CLI)
          npm install -g newman
          
          # Download collection
          curl -H "X-Api-Key: $POSTMAN_API_KEY" \
            $POSTMAN_COLLECTION_URL \
            -o collection.json
          
          # Run smoke tests against green environment
          GREEN_URL=$(aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --query 'services[0].loadBalancers[0].targetGroupArn' \
            --output text)
          
          newman run collection.json \
            --env-var "base_url=https://api-staging.betfuz.com" \
            --reporters cli,json \
            --reporter-json-export test-results.json

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: postman-test-results
          path: test-results.json

      - name: Hot-wallet smoke test (‚Ç¶100)
        id: wallet-smoke-test
        continue-on-error: true
        run: |
          echo "üî• Starting hot-wallet smoke test with ‚Ç¶${{ env.SMOKE_TEST_AMOUNT }}..."
          
          # Get green environment URL
          GREEN_URL="https://api-staging.betfuz.com"
          
          # 1. Create test user account
          TEST_USER_EMAIL="smoke-test-$(date +%s)@betfuz.com"
          echo "Creating test user: $TEST_USER_EMAIL"
          
          TEST_USER_RESPONSE=$(curl -X POST ${GREEN_URL}/api/auth/signup \
            -H "Content-Type: application/json" \
            -d "{\"email\":\"$TEST_USER_EMAIL\",\"password\":\"SmokeTest123!\",\"full_name\":\"Smoke Test\"}" \
            -s -w "\n%{http_code}")
          
          HTTP_CODE=$(echo "$TEST_USER_RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$TEST_USER_RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "201" ]; then
            echo "‚ùå Failed to create test user (HTTP $HTTP_CODE)"
            echo "$RESPONSE_BODY"
            exit 1
          fi
          
          TEST_USER_ID=$(echo $RESPONSE_BODY | jq -r '.user.id // .id')
          TEST_USER_TOKEN=$(echo $RESPONSE_BODY | jq -r '.token // .access_token')
          
          echo "‚úÖ Test user created: $TEST_USER_ID"
          
          # 2. Deposit ‚Ç¶100 to hot-wallet
          echo "Initiating deposit of ‚Ç¶${{ env.SMOKE_TEST_AMOUNT }}..."
          
          DEPOSIT_RESPONSE=$(curl -X POST ${GREEN_URL}/api/payments/deposit \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $TEST_USER_TOKEN" \
            -d "{\"amount\":${{ env.SMOKE_TEST_AMOUNT }},\"currency\":\"NGN\",\"method\":\"test\"}" \
            -s)
          
          DEPOSIT_STATUS=$(echo $DEPOSIT_RESPONSE | jq -r '.status // .success')
          
          if [ "$DEPOSIT_STATUS" != "success" ] && [ "$DEPOSIT_STATUS" != "true" ]; then
            echo "‚ùå Deposit failed: $DEPOSIT_RESPONSE"
            exit 1
          fi
          
          echo "‚úÖ Deposit successful: ‚Ç¶${{ env.SMOKE_TEST_AMOUNT }}"
          
          # 3. Verify balance update
          sleep 5  # Wait for ledger update
          
          BALANCE_RESPONSE=$(curl -X GET ${GREEN_URL}/api/users/balance \
            -H "Authorization: Bearer $TEST_USER_TOKEN" \
            -s)
          
          BALANCE=$(echo $BALANCE_RESPONSE | jq -r '.balance // .data.balance')
          
          if [ "$BALANCE" != "${{ env.SMOKE_TEST_AMOUNT }}" ]; then
            echo "‚ö†Ô∏è Balance mismatch. Expected: ${{ env.SMOKE_TEST_AMOUNT }}, Got: $BALANCE"
            echo "Continuing test..."
          else
            echo "‚úÖ Balance verified: ‚Ç¶$BALANCE"
          fi
          
          # 4. Place a test bet
          echo "Placing test bet (‚Ç¶50 stake)..."
          
          BET_RESPONSE=$(curl -X POST ${GREEN_URL}/api/bets/place \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $TEST_USER_TOKEN" \
            -d "{\"stake\":50,\"bet_type\":\"single\",\"selections\":[{\"match_id\":\"smoke-test\",\"selection_type\":\"home_win\",\"selection_value\":\"home\",\"odds\":2.0}]}" \
            -s)
          
          BET_ID=$(echo $BET_RESPONSE | jq -r '.bet_slip_id // .id')
          
          if [ "$BET_ID" == "null" ] || [ -z "$BET_ID" ]; then
            echo "‚ùå Bet placement failed: $BET_RESPONSE"
            exit 1
          fi
          
          echo "‚úÖ Bet placed: $BET_ID (‚Ç¶50 stake)"
          
          # 5. Verify bet was recorded in ledger
          sleep 3
          
          LEDGER_CHECK=$(curl -X GET ${GREEN_URL}/api/users/ledger \
            -H "Authorization: Bearer $TEST_USER_TOKEN" \
            -s)
          
          BET_ENTRY=$(echo $LEDGER_CHECK | jq -r ".entries[] | select(.reference_id == \"$BET_ID\")")
          
          if [ -z "$BET_ENTRY" ]; then
            echo "‚ö†Ô∏è Bet not found in ledger (may be async)"
          else
            echo "‚úÖ Bet confirmed in immutable ledger"
          fi
          
          # 6. Initiate withdrawal of remaining balance
          echo "Initiating withdrawal (‚Ç¶50)..."
          
          WITHDRAW_RESPONSE=$(curl -X POST ${GREEN_URL}/api/payments/withdraw \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $TEST_USER_TOKEN" \
            -d "{\"amount\":50,\"currency\":\"NGN\",\"method\":\"bank_transfer\",\"account_number\":\"0123456789\",\"bank_code\":\"058\"}" \
            -s)
          
          WITHDRAW_STATUS=$(echo $WITHDRAW_RESPONSE | jq -r '.status')
          
          if [ "$WITHDRAW_STATUS" != "pending" ] && [ "$WITHDRAW_STATUS" != "success" ] && [ "$WITHDRAW_STATUS" != "processing" ]; then
            echo "‚ùå Withdrawal failed: $WITHDRAW_RESPONSE"
            exit 1
          fi
          
          echo "‚úÖ Withdrawal initiated: ‚Ç¶50 (status: $WITHDRAW_STATUS)"
          
          # Output for next steps
          echo "test_user_id=$TEST_USER_ID" >> $GITHUB_OUTPUT
          echo "bet_id=$BET_ID" >> $GITHUB_OUTPUT
          
          echo ""
          echo "üéâ Hot-wallet smoke test PASSED"
          echo "   Test User: $TEST_USER_ID"
          echo "   Bet ID: $BET_ID"
          echo "   All financial operations validated with real money (‚Ç¶${{ env.SMOKE_TEST_AMOUNT }})"

      - name: Rollback on failure
        if: steps.postman-tests.outcome == 'failure' || steps.wallet-smoke-test.outcome == 'failure'
        run: |
          echo "‚ùå Smoke tests failed! Initiating rollback..."
          
          # Determine which test failed
          if [ "${{ steps.postman-tests.outcome }}" == "failure" ]; then
            echo "Failed test: Postman API smoke tests"
          fi
          
          if [ "${{ steps.wallet-smoke-test.outcome }}" == "failure" ]; then
            echo "Failed test: Hot-wallet ‚Ç¶${{ env.SMOKE_TEST_AMOUNT }} smoke test"
          fi
          
          # Trigger CodeDeploy to stop deployment (automatic rollback)
          DEPLOYMENT_ID=$(aws deploy list-deployments \
            --application-name betfuz-codedeploy-app \
            --deployment-group-name betfuz-deployment-group \
            --include-only-statuses InProgress \
            --query 'deployments[0]' \
            --output text)
          
          if [ "$DEPLOYMENT_ID" != "None" ]; then
            aws deploy stop-deployment \
              --deployment-id $DEPLOYMENT_ID \
              --auto-rollback-enabled
            
            echo "Rollback initiated for deployment $DEPLOYMENT_ID"
          fi
          
          # Alert on-call engineer
          curl -X POST "${{ secrets.PAGERDUTY_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"routing_key\": \"${{ secrets.PAGERDUTY_ROUTING_KEY }}\",
              \"event_action\": \"trigger\",
              \"payload\": {
                \"summary\": \"üö® Betfuz Deployment FAILED - Rollback Initiated\",
                \"severity\": \"critical\",
                \"source\": \"GitHub Actions\",
                \"custom_details\": {
                  \"version\": \"${{ steps.version.outputs.VERSION }}\",
                  \"postman_tests\": \"${{ steps.postman-tests.outcome }}\",
                  \"wallet_smoke_test\": \"${{ steps.wallet-smoke-test.outcome }}\",
                  \"rollback_initiated\": true
                }
              }
            }" || echo "PagerDuty alert failed (webhook may not be configured)"
          
          exit 1

      - name: Notify deployment success
        if: success()
        run: |
          echo "‚úÖ Deployment successful: v${{ steps.version.outputs.VERSION }}"
          echo "Green environment is now active and serving traffic"
          echo "Hot-wallet smoke test: PASSED (‚Ç¶${{ env.SMOKE_TEST_AMOUNT }})"
          
          # Notify team via Slack
          curl -X POST "${{ secrets.SLACK_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"üöÄ Betfuz v${{ steps.version.outputs.VERSION }} deployed successfully!\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Deployment Successful* ‚úÖ\\n\\n*Version:* v${{ steps.version.outputs.VERSION }}\\n*Environment:* Production\\n*Postman Tests:* ${{ steps.postman-tests.outcome }}\\n*Hot-Wallet Test:* ${{ steps.wallet-smoke-test.outcome }} (‚Ç¶${{ env.SMOKE_TEST_AMOUNT }})\\n*Test User:* \`${{ steps.wallet-smoke-test.outputs.test_user_id }}\`\\n*Test Bet:* \`${{ steps.wallet-smoke-test.outputs.bet_id }}\`\"
                  }
                },
                {
                  \"type\": \"context\",
                  \"elements\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"All financial operations validated with real money before going live.\"
                    }
                  ]
                }
              ]
            }" || echo "Slack notification failed (webhook may not be configured)"

      - name: Notify deployment failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Deployment Failed: v${{ steps.version.outputs.VERSION }}`,
              body: `Deployment failed and was rolled back.\n\nCheck workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`,
              labels: ['deployment-failure']
            })
